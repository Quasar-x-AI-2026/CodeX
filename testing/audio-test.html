<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeX - Ultimate Audio Engine</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=JetBrains+Mono&display=swap');

        :root {
            --primary: #6366f1;
            --primary-glow: rgba(99, 102, 241, 0.5);
            --bg: #0b0f1a;
            --card-bg: rgba(20, 26, 45, 0.9);
            --text: #f8fafc;
            --text-dim: #94a3b8;
            --accent: #10b981;
            --accent-glow: rgba(16, 185, 129, 0.4);
            --error: #f43f5e;
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background-color: var(--bg);
            background-image:
                radial-gradient(circle at 10% 10%, rgba(99, 102, 241, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 90%, rgba(16, 185, 129, 0.1) 0%, transparent 40%);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
        }

        .container {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
        }

        h1 {
            font-size: 3rem;
            font-weight: 800;
            text-align: center;
            background: linear-gradient(135deg, #fff 0%, #a5b4fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 2rem;
        }

        .input-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        input,
        select {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--glass-border);
            border-radius: 0.75rem;
            padding: 0.8rem;
            color: white;
            font-size: 1rem;
        }

        .btn {
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            border: none;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn-primary {
            background: var(--primary);
            box-shadow: 0 4px 15px var(--primary-glow);
        }

        .btn-accent {
            background: var(--accent);
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .btn-stop {
            background: var(--error);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: scale(0.98);
        }

        .transcript-box {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid var(--primary);
            border-radius: 1.5rem;
            padding: 1.5rem;
            position: relative;
        }

        .transcript-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        #voiceStatusBadge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.4rem 1rem;
            border-radius: 2rem;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .pulse-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4b5563;
        }

        .pulse-dot.ready {
            background: #fbbf24;
            box-shadow: 0 0 10px #fbbf24;
        }

        .pulse-dot.active {
            background: #10b981;
            box-shadow: 0 0 15px #10b981;
            animation: pulse 1s infinite;
        }

        .pulse-dot.error {
            background: #ef4444;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        #liveTranscriptArea {
            width: 100%;
            height: 300px;
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            line-height: 1.6;
            resize: none;
            outline: none;
            font-weight: 400;
        }

 
        .viz-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        canvas {
            width: 100%;
            height: 60px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0.75rem;
            border: 1px solid var(--glass-border);
        }

        #logArea {
            height: 100px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 1rem;
            padding: 0.8rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            overflow-y: auto;
            color: #10b981;
            margin-top: 1rem;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>CodeX Transcription</h1>

        <div class="glass-card">
            <div class="input-row">
                <div class="field">
                    <label>Port</label>
                    <input type="number" id="serverPort" value="3000">
                </div>
                <div class="field">
                    <label>Session ID</label>
                    <input type="text" id="sessionId" value="test-lecture">
                </div>
                <div class="field">
                    <label>My Role</label>
                    <select id="roleSelect">
                        <option value="teacher">Teacher (Presenter)</option>
                        <option value="student">Student (Listener)</option>
                    </select>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button id="connectBtn" class="btn btn-primary" style="flex: 1;">Connect System</button>
                <button id="startBtn" class="btn btn-accent" style="flex: 1;" disabled>Start Presentation</button>
                <button id="unmuteBtn" class="btn"
                    style="background: #fbbf24; color: #000; flex: 1; display: none;">Unmute Audio</button>
            </div>
        </div>

        <div class="transcript-box">
            <div class="transcript-status">
                <span style="font-weight: 800; color: var(--primary); font-size: 0.9rem;">LIVE TRANSCRIPTION
                    ENGINE</span>
                <div id="voiceStatusBadge">
                    <div id="statusDot" class="pulse-dot"></div>
                    <span id="statusText">SYSTEM STANDBY</span>
                </div>
            </div>

            <textarea id="liveTranscriptArea"
                placeholder="Click 'Start' and speak clearly. Your words will appear here..."></textarea>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                <span id="wordCountBadge" class="badge" style="color: var(--text-dim); font-size: 0.8rem;">Words:
                    0</span>
                <button id="stopBtn" class="btn btn-stop" disabled>End & Summarize</button>
            </div>
        </div>

        <div class="viz-row">
            <div class="field">
                <label>Input Level</label>
                <canvas id="localViz"></canvas>
            </div>
            <div class="field">
                <label>Peer Link</label>
                <canvas id="remoteViz"></canvas>
            </div>
        </div>

        <div id="summaryBox"
            style="display: none; background: rgba(16, 185, 129, 0.1); border: 2px solid var(--accent); border-radius: 1.5rem; padding: 2rem; margin-top: 1rem;">
            <h3 style="color: var(--accent); margin-bottom: 1rem;">AI Session Summary</h3>
            <div id="summaryContent" style="white-space: pre-wrap; font-size: 1.1rem; line-height: 1.7;"></div>
        </div>

        <div id="logArea"></div>
    </div>

    <script>
        const $ = id => document.getElementById(id);
        const log = (msg) => {
            const entry = document.createElement('div');
            entry.innerHTML = `<span style="color: #64748b;">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
            $('logArea').appendChild(entry);
            $('logArea').scrollTop = $('logArea').scrollHeight;
            console.log(`[LOG] ${msg}`);
        };

        let ws = null;
        let localStream = null;
        let pc = null;
        let recognition = null;
        let isActive = false;
        let currentTranscript = "";
        let mySocketId = null;
        let otherId = null;
        let audioElements = [];

        $('connectBtn').onclick = () => {
            const port = $('serverPort').value;
            const sessionId = $('sessionId').value;
            const role = $('roleSelect').value;

            if (ws) ws.close();
            ws = new WebSocket(`ws://localhost:${port}`);

            $('statusText').innerText = "CONNECTING WS...";

            ws.onopen = () => {
                log("System Connected via WebSocket");
                $('statusText').innerText = "SYSTEM READY";
                ws.send(JSON.stringify({
                    channel: '/signal',
                    payload: { type: 'join', sessionId, role }
                }));
                $('startBtn').disabled = false;
                $('connectBtn').disabled = true;
            };

            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === 'welcome') {
                    mySocketId = data.socketId;
                    log(`Identity Confirmed: ${mySocketId}`);
                } else if (data.channel === '/signal') {
                    handleSignal(data.payload);
                } else if (data.channel === '/audio' && data.payload.type === 'summary') {
                    $('summaryBox').style.display = 'block';
                    $('summaryContent').innerText = data.payload.summary;
                    log("AI Summary Received");
                }
            };
        };


        function initRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return null;

            const rec = new SpeechRecognition();
            rec.continuous = true;
            rec.interimResults = true;
            rec.lang = 'en-US';

            rec.onstart = () => {
                log("Voice Recognition: STARTED");
                $('statusDot').className = "pulse-dot active";
                $('statusText').innerText = "LISTENING...";
            };

            rec.onresult = (event) => {
                let final = "";
                for (let i = 0; i < event.results.length; ++i) {
                    final += event.results[i][0].transcript + " ";
                }
                currentTranscript = final.trim();
                $('liveTranscriptArea').value = currentTranscript;
                $('wordCountBadge').innerText = `Words: ${currentTranscript.split(/\s+/).length}`;
            };

            rec.onerror = (event) => {
                log(`Engine Error: ${event.error}`);
                if (event.error === 'not-allowed') {
                    $('statusDot').className = "pulse-dot error";
                    $('statusText').innerText = "MIC ACCESS DENIED";
                }
            };

            rec.onend = () => {
                if (isActive) {
                    log("Engine Disconnected. Auto-Restarting...");
                    try { rec.start(); } catch (e) { }
                } else {
                    log("Engine Shutdown Cleanly");
                    $('statusDot').className = "pulse-dot";
                    $('statusText').innerText = "SYSTEM STANDBY";
                }
            };

            return rec;
        }


        $('startBtn').onclick = async () => {
            const role = $('roleSelect').value;
            isActive = true;

            try {
                
                if (role === 'teacher') {
                    log("Initializing Microphone Hardware...");
                    if (!localStream) {
                        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        log("Mic Access GRANTED");
                        setupViz(localStream, 'localViz', '#6366f1');
                    }
                }

                
                if (!recognition) recognition = initRecognition();
                if (recognition) {
                    try { recognition.start(); } catch (e) { log("Engine already warm."); }
                } else {
                    log("CRITICAL: Browser Speech API missing!");
                    alert("This browser doesn't support live transcription. Use Chrome.");
                }

                $('startBtn').disabled = true;
                $('stopBtn').disabled = false;

                if (role === 'teacher') {
                    ws.send(JSON.stringify({ channel: '/audio', payload: { type: 'start', locale: 'en-US' } }));
                    log("Lecture Broadcast LIVE");

               
                    if (otherId) {
                        log("Initiating RTC link with existing peer...");
                        pc = createPC(otherId);
                        const offer = await pc.createOffer();
                        await pc.setLocalDescription(offer);
                        ws.send(JSON.stringify({
                            channel: '/signal',
                            payload: { type: 'offer', offer, targetSocketId: otherId }
                        }));
                    }
                }
            } catch (err) {
                log(`Start Failure: ${err.message}`);
                isActive = false;
            }
        };

        $('stopBtn').onclick = () => {
            isActive = false;
            log("Ending Presentation...");

            if (recognition) {
                try { recognition.stop(); } catch (e) { }
            }

            ws.send(JSON.stringify({
                channel: '/audio',
                payload: { type: 'stop', transcript: currentTranscript }
            }));

            if (localStream) {
                localStream.getTracks().forEach(t => t.stop());
                localStream = null;
            }

            $('startBtn').disabled = false;
            $('stopBtn').disabled = true;
        };

       
        async function handleSignal(payload) {
            const { type, from, offer, answer, candidate } = payload;
            if (from === mySocketId) return;

            otherId = from;
            log(`RTC Signal: ${type} from ${from}`);
            if (type === 'peer-joined') {
                log(`New Peer joined: ${from}`);
                if ($('roleSelect').value === 'teacher' && isActive) {
                    log("Sending offer to new peer...");
                    pc = createPC(from);
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);
                    ws.send(JSON.stringify({
                        channel: '/signal',
                        payload: { type: 'offer', offer, targetSocketId: from }
                    }));
                }
            } else if (type === 'offer') {
                log("RTC Offer Received");
                pc = createPC(from);
                await pc.setRemoteDescription(new RTCSessionDescription(offer));
                const ans = await pc.createAnswer();
                await pc.setLocalDescription(ans);
                ws.send(JSON.stringify({ channel: '/signal', payload: { type: 'answer', answer: ans, targetSocketId: from } }));
            } else if (type === 'answer') {
                log("RTC Answer Received");
                if (pc) await pc.setRemoteDescription(new RTCSessionDescription(answer));
            } else if (type === 'candidate') {
                if (pc) await pc.addIceCandidate(new RTCIceCandidate(candidate));
            }
        }

        function createPC(targetId) {
            if (pc) pc.close();
            pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

            pc.onicecandidate = (e) => {
                if (e.candidate) {
                    ws.send(JSON.stringify({ channel: '/signal', payload: { type: 'candidate', candidate: e.candidate, targetSocketId: targetId } }));
                }
            };

            pc.oniceconnectionstatechange = () => {
                log(`ICE State: ${pc.iceConnectionState}`);
            };

            pc.onconnectionstatechange = () => {
                log(`Connection State: ${pc.connectionState}`);
            };

            const role = $('roleSelect').value;
            if (role === 'teacher' && localStream) {
                localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            } else {
                pc.ontrack = (e) => {
                    log("REMOTE TRACK RECEIVED! Creating audio...");
                    const audio = new Audio();
                    audio.srcObject = e.streams[0];
                    audio.autoplay = true;

                    $('unmuteBtn').style.display = 'block';
                    $('unmuteBtn').onclick = () => {
                        audio.play().then(() => {
                            log("Audio Playing Successfully");
                            $('unmuteBtn').style.display = 'none';
                        }).catch(err => log("Playback error: " + err.message));
                    };

                    audio.play().then(() => {
                        log("Auto-play Success");
                        $('unmuteBtn').style.display = 'none';
                    }).catch(err => {
                        log("Browser blocked auto-play. Please click 'Unmute Audio'.");
                    });

                    audioElements.push(audio);
                    setupViz(e.streams[0], 'remoteViz', '#10b981');
                };
            }
            return pc;
        }

        function setupViz(stream, canvasId, color) {
            const canvas = $(canvasId);
            const ctx = canvas.getContext('2d');
            const audioCtx = new AudioContext();
            const source = audioCtx.createMediaStreamSource(stream);
            const analyser = audioCtx.createAnalyser();
            analyser.fftSize = 64;
            source.connect(analyser);
            const data = new Uint8Array(analyser.frequencyBinCount);

            function draw() {
                if (!stream.active) return;
                requestAnimationFrame(draw);
                analyser.getByteFrequencyData(data);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                const w = canvas.width / data.length;
                data.forEach((v, i) => {
                    ctx.fillStyle = color;
                    ctx.fillRect(i * w, canvas.height - (v / 255) * canvas.height, w - 2, (v / 255) * canvas.height);
                });
            }
            draw();
        }

        document.querySelectorAll('canvas').forEach(c => { c.width = c.parentElement.clientWidth; c.height = 60; });
    </script>
</body>

</html>